<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="action_server_split_outgoing_picking" model="ir.actions.server">
        <field name="name">Auto-Split: Create Internal Transfer for Salesperson</field>
        <field name="model_id" ref="stock.model_stock_picking"/>
        <field name="state">code</field>
        <field name="code">
# Server action code - v3 (Handles MTO vs Stockable)
location_stock = env['stock.location'].search([('complete_name', '=', 'WH/Stock')], limit=1)

if location_stock:
    for picking in records:
        # Basic validation: only process outgoing pickings that are not done/cancelled.
        if picking.picking_type_code != 'outgoing' or picking.state in ('done', 'cancel'):
            continue

        # 1. Find salesperson and their location
        salesperson = picking.sale_id.user_id or (picking.pos_order_id and picking.pos_order_id.user_id)
        if not salesperson or not salesperson.partner_id.ref:
            continue
        commercial_ref = salesperson.partner_id.ref
        location_comercial = env['stock.location'].search([('name', '=', commercial_ref)], limit=1)
        if not location_comercial:
            continue

        # 2. *** KEY IMPROVEMENT: Protection against re-running ***
        # If the picking's source location is already the commercial's location, we are done.
        if picking.location_id.id == location_comercial.id:
            continue

        # 3. Differentiate logic for MTO vs Stockable products
        # We assume all moves in the picking are of the same type for simplicity.
        is_mto = picking.move_ids and picking.move_ids[0].procure_method == 'make_to_order'

        if is_mto:
            # --- MTO LOGIC ---
            # For MTO products, we just change the source location of the outgoing picking.
            # Odoo's procurement system will then know to make the stock available there.
            picking.write({'location_id': location_comercial.id})
            picking.move_ids.write({'location_id': location_comercial.id})
            picking.message_post(body="Source location changed to salesperson's location for MTO fulfillment.")
        else:
            # --- STOCKABLE PRODUCT LOGIC ---
            # This is the original logic: create an internal transfer and chain it.
            picking_type_internal = env['stock.picking.type'].search([('code', '=', 'internal'), ('warehouse_id', '=', picking.picking_type_id.warehouse_id.id)], limit=1)
            if not picking_type_internal:
                continue

            picking.do_unreserve()

            internal_move_lines = []
            for move in picking.move_ids:
                internal_move_lines.append((0, 0, {
                    'product_id': move.product_id.id, 'product_uom_qty': move.product_uom_qty,
                    'product_uom': move.product_uom.id, 'location_id': location_stock.id,
                    'location_dest_id': location_comercial.id, 'move_dest_ids': [(4, move.id)]
                }))
            if not internal_move_lines:
                continue

            internal_picking = env['stock.picking'].create({
                'picking_type_id': picking_type_internal.id, 'location_id': location_stock.id,
                'location_dest_id': location_comercial.id, 'origin': picking.name,
                'partner_id': picking.partner_id.id, 'move_ids': internal_move_lines,
            })
            internal_picking.action_confirm()

            picking.write({'location_id': location_comercial.id})
            # Here, we set procure_method to chain the picking, which is fine because it's not an MTO product.
            picking.move_ids.write({'location_id': location_comercial.id, 'procure_method': 'make_to_order'})

            internal_picking.message_post(body=f"Created to supply outgoing picking &lt;a href='#' data-oe-model='stock.picking' data-oe-id='{picking.id}'&gt;{picking.name}&lt;/a&gt;.")
            picking.message_post(body=f"This picking is waiting for internal transfer &lt;a href='#' data-oe-model='stock.picking' data-oe-id='{internal_picking.id}'&gt;{internal_picking.name}&lt;/a&gt;.")
        </field>
    </record>
</odoo>
